---
title: Spravovaná a nespravovaná vlákna ve Windows
ms.date: 10/24/2018
ms.technology: dotnet-standard
helpviewer_keywords:
- threading [.NET Framework], unmanaged
- threading [.NET Framework], managed
- threading [.NET], managed
- threads and fibers [.NET]
- managed threading
ms.assetid: 4fb6452f-c071-420d-9e71-da16dee7a1eb
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: da32d514b19424487cebc1d113388cfa9a2dbdf0
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 08/22/2019
ms.locfileid: "69913231"
---
# <a name="managed-and-unmanaged-threading-in-windows"></a><span data-ttu-id="4aae3-102">Spravovaná a nespravovaná vlákna ve Windows</span><span class="sxs-lookup"><span data-stu-id="4aae3-102">Managed and unmanaged threading in Windows</span></span>

<span data-ttu-id="4aae3-103">Správa všech vláken je prováděna prostřednictvím <xref:System.Threading.Thread> třídy, včetně vláken vytvořených modulem CLR (Common Language Runtime) a vytvořených mimo modul runtime, který do spravovaného prostředí zadává kód.</span><span class="sxs-lookup"><span data-stu-id="4aae3-103">Management of all threads is done through the <xref:System.Threading.Thread> class, including threads created by the common language runtime and those created outside the runtime that enter the managed environment to execute code.</span></span> <span data-ttu-id="4aae3-104">Modul runtime monitoruje všechna vlákna ve svém procesu, který ve spravovaném prostředí pro spuštění někdy spustil kód.</span><span class="sxs-lookup"><span data-stu-id="4aae3-104">The runtime monitors all the threads in its process that have ever executed code within the managed execution environment.</span></span> <span data-ttu-id="4aae3-105">Nesleduje žádné další podprocesy.</span><span class="sxs-lookup"><span data-stu-id="4aae3-105">It does not track any other threads.</span></span> <span data-ttu-id="4aae3-106">Vlákna mohou pomocí zprostředkovatele komunikace s objekty COM vstoupit do prostředí spravovaného spuštění (protože modul runtime zveřejňuje spravované objekty jako objekty COM na nespravovaný svět), funkci [DLLGETCLASSOBJECT](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) com a vyvolání platformy.</span><span class="sxs-lookup"><span data-stu-id="4aae3-106">Threads can enter the managed execution environment through COM interop (because the runtime exposes managed objects as COM objects to the unmanaged world), the COM [DllGetClassObject](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) function, and platform invoke.</span></span>  
  
 <span data-ttu-id="4aae3-107">Když nespravované vlákno vstoupí do modulu runtime prostřednictvím, například obálka s podporou modelu COM, systém zkontroluje místní úložiště vlákna daného vlákna, aby hledal interní spravovaný <xref:System.Threading.Thread> objekt.</span><span class="sxs-lookup"><span data-stu-id="4aae3-107">When an unmanaged thread enters the runtime through, for example, a COM callable wrapper, the system checks the thread-local store of that thread to look for an internal managed <xref:System.Threading.Thread> object.</span></span> <span data-ttu-id="4aae3-108">Pokud je některý z nich nalezen, modul runtime je již o tomto vláknu vědom.</span><span class="sxs-lookup"><span data-stu-id="4aae3-108">If one is found, the runtime is already aware of this thread.</span></span> <span data-ttu-id="4aae3-109">Pokud ale nemůže nějaký najít, modul runtime vytvoří nový <xref:System.Threading.Thread> objekt a nainstaluje ho do úložiště místního vlákna tohoto vlákna.</span><span class="sxs-lookup"><span data-stu-id="4aae3-109">If it cannot find one, however, the runtime builds a new <xref:System.Threading.Thread> object and installs it in the thread-local store of that thread.</span></span>  
  
 <span data-ttu-id="4aae3-110">Ve spravovaném vlákně <xref:System.Threading.Thread.GetHashCode%2A?displayProperty=nameWithType> je stabilním identifikátorem spravovaného vlákna.</span><span class="sxs-lookup"><span data-stu-id="4aae3-110">In managed threading, <xref:System.Threading.Thread.GetHashCode%2A?displayProperty=nameWithType> is the stable managed thread identification.</span></span> <span data-ttu-id="4aae3-111">Po celou dobu životnosti vlákna se nebude kolidovat s hodnotou z žádného jiného vlákna bez ohledu na doménu aplikace, ze které tuto hodnotu získáváte.</span><span class="sxs-lookup"><span data-stu-id="4aae3-111">For the lifetime of your thread, it will not collide with the value from any other thread, regardless of the application domain from which you obtain this value.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="4aae3-112">**IDvlákna** operačního systému nemá žádný pevný vztah ke spravovanému vláknu, protože nespravovaný hostitel může řídit vztah mezi spravovanými a nespravovanými vlákny.</span><span class="sxs-lookup"><span data-stu-id="4aae3-112">An operating-system **ThreadId** has no fixed relationship to a managed thread, because an unmanaged host can control the relationship between managed and unmanaged threads.</span></span> <span data-ttu-id="4aae3-113">Konkrétně propracované hostitel může použít rozhraní Fiber API k naplánování mnoha spravovaných vláken proti stejnému vláknu operačního systému nebo k přesunutí spravovaného vlákna mezi různými vlákny operačního systému.</span><span class="sxs-lookup"><span data-stu-id="4aae3-113">Specifically, a sophisticated host can use the Fiber API to schedule many managed threads against the same operating system thread, or to move a managed thread among different operating system threads.</span></span>  
  
## <a name="mapping-from-win32-threading-to-managed-threading"></a><span data-ttu-id="4aae3-114">Mapování z vlákna Win32 do spravovaného vlákna</span><span class="sxs-lookup"><span data-stu-id="4aae3-114">Mapping from Win32 threading to managed threading</span></span>

 <span data-ttu-id="4aae3-115">Následující tabulka mapuje prvky vláken Win32 na jejich přibližný ekvivalent za běhu.</span><span class="sxs-lookup"><span data-stu-id="4aae3-115">The following table maps Win32 threading elements to their approximate runtime equivalent.</span></span> <span data-ttu-id="4aae3-116">Všimněte si, že toto mapování nepředstavuje stejné funkce.</span><span class="sxs-lookup"><span data-stu-id="4aae3-116">Note that this mapping does not represent identical functionality.</span></span> <span data-ttu-id="4aae3-117">**TerminateThread** například neprovede klauzule **finally** nebo uvolní prostředky a nelze je zabránit.</span><span class="sxs-lookup"><span data-stu-id="4aae3-117">For example, **TerminateThread** does not execute **finally** clauses or free up resources, and cannot be prevented.</span></span> <span data-ttu-id="4aae3-118">Spustí se ale veškerý váš kód vrácení zpět, uvolní všechny prostředky a může být odepřen pomocí <xref:System.Threading.Thread.ResetAbort%2A>. <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="4aae3-118">However, <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType> executes all your rollback code, reclaims all the resources, and can be denied using <xref:System.Threading.Thread.ResetAbort%2A>.</span></span> <span data-ttu-id="4aae3-119">Nezapomeňte si před tím, než začnete vytvářet předpoklady o funkcích, pečlivě si přečtěte dokumentaci.</span><span class="sxs-lookup"><span data-stu-id="4aae3-119">Be sure to read the documentation closely before making assumptions about functionality.</span></span>  
  
|<span data-ttu-id="4aae3-120">V systému Win32</span><span class="sxs-lookup"><span data-stu-id="4aae3-120">In Win32</span></span>|<span data-ttu-id="4aae3-121">V modulu CLR (Common Language Runtime)</span><span class="sxs-lookup"><span data-stu-id="4aae3-121">In the common language runtime</span></span>|  
|--------------|------------------------------------|  
|<span data-ttu-id="4aae3-122">**CreateThread**</span><span class="sxs-lookup"><span data-stu-id="4aae3-122">**CreateThread**</span></span>|<span data-ttu-id="4aae3-123">Kombinace **vlákna** a<xref:System.Threading.ThreadStart></span><span class="sxs-lookup"><span data-stu-id="4aae3-123">Combination of **Thread** and <xref:System.Threading.ThreadStart></span></span>|  
|<span data-ttu-id="4aae3-124">**TerminateThread**</span><span class="sxs-lookup"><span data-stu-id="4aae3-124">**TerminateThread**</span></span>|<xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType>|  
|<span data-ttu-id="4aae3-125">**SuspendThread**</span><span class="sxs-lookup"><span data-stu-id="4aae3-125">**SuspendThread**</span></span>|<xref:System.Threading.Thread.Suspend%2A?displayProperty=nameWithType>|  
|<span data-ttu-id="4aae3-126">**ResumeThread**</span><span class="sxs-lookup"><span data-stu-id="4aae3-126">**ResumeThread**</span></span>|<xref:System.Threading.Thread.Resume%2A?displayProperty=nameWithType>|  
|<span data-ttu-id="4aae3-127">**Spat**</span><span class="sxs-lookup"><span data-stu-id="4aae3-127">**Sleep**</span></span>|<xref:System.Threading.Thread.Sleep%2A?displayProperty=nameWithType>|  
|<span data-ttu-id="4aae3-128">**WaitForSingleObject** v popisovači vlákna</span><span class="sxs-lookup"><span data-stu-id="4aae3-128">**WaitForSingleObject** on the thread handle</span></span>|<xref:System.Threading.Thread.Join%2A?displayProperty=nameWithType>|  
|<span data-ttu-id="4aae3-129">**ExitThread –**</span><span class="sxs-lookup"><span data-stu-id="4aae3-129">**ExitThread**</span></span>|<span data-ttu-id="4aae3-130">Bez ekvivalentu</span><span class="sxs-lookup"><span data-stu-id="4aae3-130">No equivalent</span></span>|  
|<span data-ttu-id="4aae3-131">**GetCurrentThread**</span><span class="sxs-lookup"><span data-stu-id="4aae3-131">**GetCurrentThread**</span></span>|<xref:System.Threading.Thread.CurrentThread%2A?displayProperty=nameWithType>|  
|<span data-ttu-id="4aae3-132">**SetThreadPriority**</span><span class="sxs-lookup"><span data-stu-id="4aae3-132">**SetThreadPriority**</span></span>|<xref:System.Threading.Thread.Priority%2A?displayProperty=nameWithType>|  
|<span data-ttu-id="4aae3-133">Bez ekvivalentu</span><span class="sxs-lookup"><span data-stu-id="4aae3-133">No equivalent</span></span>|<xref:System.Threading.Thread.Name%2A?displayProperty=nameWithType>|  
|<span data-ttu-id="4aae3-134">Bez ekvivalentu</span><span class="sxs-lookup"><span data-stu-id="4aae3-134">No equivalent</span></span>|<xref:System.Threading.Thread.IsBackground%2A?displayProperty=nameWithType>|  
|<span data-ttu-id="4aae3-135">Blízko **funkce CoInitializeEx** (Ole32. DLL</span><span class="sxs-lookup"><span data-stu-id="4aae3-135">Close to **CoInitializeEx** (OLE32.DLL)</span></span>|<xref:System.Threading.Thread.ApartmentState%2A?displayProperty=nameWithType>|  
  
## <a name="managed-threads-and-com-apartments"></a><span data-ttu-id="4aae3-136">Spravovaná vlákna a COM Apartment</span><span class="sxs-lookup"><span data-stu-id="4aae3-136">Managed threads and COM apartments</span></span>

<span data-ttu-id="4aae3-137">Spravované vlákno může být označeno k označení toho, že bude hostovat [jeden vlákn](/windows/desktop/com/single-threaded-apartments) nebo vícevláknový [](/windows/desktop/com/multithreaded-apartments) objekt Apartment.</span><span class="sxs-lookup"><span data-stu-id="4aae3-137">A managed thread can be marked to indicate that it will host a [single-threaded](/windows/desktop/com/single-threaded-apartments) or [multithreaded](/windows/desktop/com/multithreaded-apartments) apartment.</span></span> <span data-ttu-id="4aae3-138">(Další informace o architektuře vláken COM naleznete v tématu [procesy, vlákna a objekty Apartment](/windows/desktop/com/processes--threads--and-apartments).) Metody <xref:System.Threading.Thread.GetApartmentState%2A> ,<xref:System.Threading.Thread.SetApartmentState%2A> a<xref:System.Threading.Thread.TrySetApartmentState%2A>třídyvrací a přiřazují stav objektu apartment vlákna. <xref:System.Threading.Thread></span><span class="sxs-lookup"><span data-stu-id="4aae3-138">(For more information on the COM threading architecture, see [Processes, Threads, and Apartments](/windows/desktop/com/processes--threads--and-apartments).) The <xref:System.Threading.Thread.GetApartmentState%2A>, <xref:System.Threading.Thread.SetApartmentState%2A>, and <xref:System.Threading.Thread.TrySetApartmentState%2A> methods of the <xref:System.Threading.Thread> class return and assign the apartment state of a thread.</span></span> <span data-ttu-id="4aae3-139">Pokud stav nebyl nastaven, <xref:System.Threading.Thread.GetApartmentState%2A> vrátí. <xref:System.Threading.ApartmentState.Unknown?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="4aae3-139">If the state has not been set, <xref:System.Threading.Thread.GetApartmentState%2A> returns <xref:System.Threading.ApartmentState.Unknown?displayProperty=nameWithType>.</span></span>  
  
 <span data-ttu-id="4aae3-140">Vlastnost lze nastavit pouze v případě, že vlákno je ve <xref:System.Threading.ThreadState.Unstarted?displayProperty=nameWithType> stavu, lze pro vlákno nastavit pouze jednou.</span><span class="sxs-lookup"><span data-stu-id="4aae3-140">The property can be set only when the thread is in the <xref:System.Threading.ThreadState.Unstarted?displayProperty=nameWithType> state; it can be set only once for a thread.</span></span>  
  
 <span data-ttu-id="4aae3-141">Pokud stav objektu Apartment není nastaven před spuštěním vlákna, vlákno je inicializováno jako vícevláknové prostředí (MTA).</span><span class="sxs-lookup"><span data-stu-id="4aae3-141">If the apartment state is not set before the thread is started, the thread is initialized as a multithreaded apartment (MTA).</span></span> <span data-ttu-id="4aae3-142">Finalizační vlákno a všechna vlákna řízená nástrojem <xref:System.Threading.ThreadPool> jsou typu MTA.</span><span class="sxs-lookup"><span data-stu-id="4aae3-142">The finalizer thread and all threads controlled by <xref:System.Threading.ThreadPool> are MTA.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="4aae3-143">V případě spouštěcího kódu aplikace jediným způsobem, jak řídit stav objektu apartment, je <xref:System.MTAThreadAttribute> použít <xref:System.STAThreadAttribute> nebo na proceduru vstupního bodu.</span><span class="sxs-lookup"><span data-stu-id="4aae3-143">For application startup code, the only way to control apartment state is to apply the <xref:System.MTAThreadAttribute> or the <xref:System.STAThreadAttribute> to the entry point procedure.</span></span> <span data-ttu-id="4aae3-144">V .NET Framework 1,0 a 1,1 <xref:System.Threading.Thread.ApartmentState%2A> lze vlastnost nastavit jako první řádek kódu.</span><span class="sxs-lookup"><span data-stu-id="4aae3-144">In the .NET Framework 1.0 and 1.1, the <xref:System.Threading.Thread.ApartmentState%2A> property can be set as the first line of code.</span></span> <span data-ttu-id="4aae3-145">Tato není povolená v .NET Framework 2,0.</span><span class="sxs-lookup"><span data-stu-id="4aae3-145">This is not permitted in the .NET Framework 2.0.</span></span>  
  
 <span data-ttu-id="4aae3-146">Spravované objekty, které jsou vystaveny modelu COM, se chovají, jako kdyby obsahovaly agregované zařazování vláken s volnými vlákny.</span><span class="sxs-lookup"><span data-stu-id="4aae3-146">Managed objects that are exposed to COM behave as if they had aggregated the free-threaded marshaler.</span></span> <span data-ttu-id="4aae3-147">Jinými slovy, mohou být volány z libovolného objektu COM v rámci libovolného typu s více vlákny.</span><span class="sxs-lookup"><span data-stu-id="4aae3-147">In other words, they can be called from any COM apartment in a free-threaded manner.</span></span> <span data-ttu-id="4aae3-148">Jediné spravované objekty, které se nezobrazují toto chování s volnou vláknem, jsou objekty, <xref:System.EnterpriseServices.ServicedComponent> které <xref:System.Runtime.InteropServices.StandardOleMarshalObject>jsou odvozeny z nebo.</span><span class="sxs-lookup"><span data-stu-id="4aae3-148">The only managed objects that do not exhibit this free-threaded behavior are those objects that derive from <xref:System.EnterpriseServices.ServicedComponent> or <xref:System.Runtime.InteropServices.StandardOleMarshalObject>.</span></span>  
  
 <span data-ttu-id="4aae3-149">Ve spravovaném světě není podporována podpora pro, pokud nepoužíváte kontexty a spravované instance závislé na <xref:System.Runtime.Remoting.Contexts.SynchronizationAttribute> kontextu.</span><span class="sxs-lookup"><span data-stu-id="4aae3-149">In the managed world, there is no support for the <xref:System.Runtime.Remoting.Contexts.SynchronizationAttribute> unless you use contexts and context-bound managed instances.</span></span> <span data-ttu-id="4aae3-150">Pokud používáte služby Enterprise Services, musí být objekt odvozen od <xref:System.EnterpriseServices.ServicedComponent> (který je sám odvozen z <xref:System.ContextBoundObject>).</span><span class="sxs-lookup"><span data-stu-id="4aae3-150">If you are using Enterprise Services, then your object must derive from <xref:System.EnterpriseServices.ServicedComponent> (which is itself derived from <xref:System.ContextBoundObject>).</span></span>  
  
 <span data-ttu-id="4aae3-151">Pokud spravovaný kód volá objekty modelu COM, vždy se řídí pravidly modelu COM.</span><span class="sxs-lookup"><span data-stu-id="4aae3-151">When managed code calls out to COM objects, it always follows COM rules.</span></span> <span data-ttu-id="4aae3-152">Jinými slovy volá proxy objekty COM Apartment a obálky kontextu COM+ 1,0, jak jsou vyvolány pomocí OLE32.</span><span class="sxs-lookup"><span data-stu-id="4aae3-152">In other words, it calls through COM apartment proxies and COM+ 1.0 context wrappers as dictated by OLE32.</span></span>  
  
## <a name="blocking-issues"></a><span data-ttu-id="4aae3-153">Blokování problémů</span><span class="sxs-lookup"><span data-stu-id="4aae3-153">Blocking issues</span></span>  

<span data-ttu-id="4aae3-154">Pokud vlákno vytvoří nespravované volání do operačního systému, který zablokoval vlákno v nespravovaném kódu, modul runtime je nevezme pod kontrolou pro <xref:System.Threading.Thread.Interrupt%2A?displayProperty=nameWithType> nebo. <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="4aae3-154">If a thread makes an unmanaged call into the operating system that has blocked the thread in unmanaged code, the runtime will not take control of it for <xref:System.Threading.Thread.Interrupt%2A?displayProperty=nameWithType> or <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="4aae3-155">V případě <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType>je modul runtime označen vláknem pro **přerušení** a při opětovném vložení spravovaného kódu ho převezme pod kontrolou.</span><span class="sxs-lookup"><span data-stu-id="4aae3-155">In the case of <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType>, the runtime marks the thread for **Abort** and takes control of it when it re-enters managed code.</span></span> <span data-ttu-id="4aae3-156">Doporučujeme místo nespravovaného blokování použít spravované blokování.</span><span class="sxs-lookup"><span data-stu-id="4aae3-156">It is preferable for you to use managed blocking rather than unmanaged blocking.</span></span> <span data-ttu-id="4aae3-157"><xref:System.Threading.WaitHandle.WaitOne%2A?displayProperty=nameWithType>,<xref:System.Threading.WaitHandle.WaitAny%2A?displayProperty=nameWithType> <xref:System.Threading.WaitHandle.WaitAll%2A?displayProperty=nameWithType> ,<xref:System.Threading.Monitor.TryEnter%2A?displayProperty=nameWithType>,, ,<xref:System.Threading.Thread.Join%2A?displayProperty=nameWithType>, atak<xref:System.Threading.Thread.Interrupt%2A?displayProperty=nameWithType> je vše reagovat na a .<xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType> <xref:System.GC.WaitForPendingFinalizers%2A?displayProperty=nameWithType> <xref:System.Threading.Monitor.Enter%2A?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="4aae3-157"><xref:System.Threading.WaitHandle.WaitOne%2A?displayProperty=nameWithType>,<xref:System.Threading.WaitHandle.WaitAny%2A?displayProperty=nameWithType>, <xref:System.Threading.WaitHandle.WaitAll%2A?displayProperty=nameWithType>, <xref:System.Threading.Monitor.Enter%2A?displayProperty=nameWithType>, <xref:System.Threading.Monitor.TryEnter%2A?displayProperty=nameWithType>, <xref:System.Threading.Thread.Join%2A?displayProperty=nameWithType>, <xref:System.GC.WaitForPendingFinalizers%2A?displayProperty=nameWithType>, and so on are all responsive to <xref:System.Threading.Thread.Interrupt%2A?displayProperty=nameWithType> and to <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="4aae3-158">Pokud je vlákno v izolovaném vláknu, všechny tyto spravované operace blokování budou správně pumpovat zprávy ve vašem vlákně, zatímco vaše vlákno je blokováno.</span><span class="sxs-lookup"><span data-stu-id="4aae3-158">Also, if your thread is in a single-threaded apartment, all these managed blocking operations will correctly pump messages in your apartment while your thread is blocked.</span></span>  

## <a name="threads-and-fibers"></a><span data-ttu-id="4aae3-159">Vlákna a vlákna</span><span class="sxs-lookup"><span data-stu-id="4aae3-159">Threads and fibers</span></span>

<span data-ttu-id="4aae3-160">Model vláken .NET nepodporuje [vlákna](/windows/desktop/procthread/fibers).</span><span class="sxs-lookup"><span data-stu-id="4aae3-160">The .NET threading model does not support [fibers](/windows/desktop/procthread/fibers).</span></span> <span data-ttu-id="4aae3-161">Neměli byste volat do žádné nespravované funkce, která je implementována pomocí vláken.</span><span class="sxs-lookup"><span data-stu-id="4aae3-161">You should not call into any unmanaged function that is implemented by using fibers.</span></span> <span data-ttu-id="4aae3-162">Taková volání můžou způsobit zhroucení prostředí .NET Runtime.</span><span class="sxs-lookup"><span data-stu-id="4aae3-162">Such calls may result in a crash of the .NET runtime.</span></span>

## <a name="see-also"></a><span data-ttu-id="4aae3-163">Viz také:</span><span class="sxs-lookup"><span data-stu-id="4aae3-163">See also</span></span>

- <xref:System.Threading.Thread.ApartmentState%2A?displayProperty=nameWithType>
- <xref:System.Threading.ThreadState>
- <xref:System.EnterpriseServices.ServicedComponent>
- <xref:System.Threading.Thread>
- <xref:System.Threading.Monitor>
