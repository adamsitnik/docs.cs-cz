---
title: Zrušení ve spravovaných vláknech
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- cancellation in .NET, overview
ms.assetid: eea11fe5-d8b0-4314-bb5d-8a58166fb1c3
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: 531b9b6ae62b34f78f13ff6cd1784a2823584ed6
ms.sourcegitcommit: 2701302a99cafbe0d86d53d540eb0fa7e9b46b36
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 04/28/2019
ms.locfileid: "64620775"
---
# <a name="cancellation-in-managed-threads"></a><span data-ttu-id="92b47-102">Zrušení ve spravovaných vláknech</span><span class="sxs-lookup"><span data-stu-id="92b47-102">Cancellation in Managed Threads</span></span>
<span data-ttu-id="92b47-103">Počínaje [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], rozhraní .NET Framework používá jednotný model pro kooperativní zrušení asynchronní nebo dlouhotrvající synchronní operace.</span><span class="sxs-lookup"><span data-stu-id="92b47-103">Starting with the [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], the .NET Framework uses a unified model for cooperative cancellation of asynchronous or long-running synchronous operations.</span></span> <span data-ttu-id="92b47-104">Tento model je založen na zjednodušené objekt volána token zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-104">This model is based on a lightweight object called a cancellation token.</span></span> <span data-ttu-id="92b47-105">Objekt, který vyvolá jednu nebo více operací zrušitelný, třeba tak, že vytvoříte nová vlákna nebo úlohy, předá token pro každou operaci.</span><span class="sxs-lookup"><span data-stu-id="92b47-105">The object that invokes one or more cancelable operations, for example by creating new threads or tasks, passes the token to each operation.</span></span> <span data-ttu-id="92b47-106">Jednotlivé operace můžete zase předat další operace kopie token.</span><span class="sxs-lookup"><span data-stu-id="92b47-106">Individual operations can in turn pass copies of the token to other operations.</span></span> <span data-ttu-id="92b47-107">Později objekt, který vytvoří token, který slouží k požadavku, že operace zastavit, co dělají.</span><span class="sxs-lookup"><span data-stu-id="92b47-107">At some later time, the object that created the token can use it to request that the operations stop what they are doing.</span></span> <span data-ttu-id="92b47-108">Pouze žádost o objekt může vydat žádost o zrušení a každý naslouchací proces je zodpovědný za řadí žádosti a reagovat na ni vhodné a včasné způsobem.</span><span class="sxs-lookup"><span data-stu-id="92b47-108">Only the requesting object can issue the cancellation request, and each listener is responsible for noticing the request and responding to it in an appropriate and timely manner.</span></span>  
  
 <span data-ttu-id="92b47-109">Je obecný vzor implementace vzoru kooperativní zrušení:</span><span class="sxs-lookup"><span data-stu-id="92b47-109">The general pattern for implementing the cooperative cancellation model is:</span></span>  
  
- <span data-ttu-id="92b47-110">Vytvořit instanci <xref:System.Threading.CancellationTokenSource> objektu, který spravuje a odešle oznámení o zrušení tokenů jednotlivé zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-110">Instantiate a <xref:System.Threading.CancellationTokenSource> object, which manages and sends cancellation notification to the individual cancellation tokens.</span></span>  
  
- <span data-ttu-id="92b47-111">Předat token vrácený <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> vlastnost pro každý úkol nebo vláknem, které čeká na zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-111">Pass the token returned by the <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> property to each task or thread that listens for cancellation.</span></span>  
  
- <span data-ttu-id="92b47-112">Poskytuje mechanismus pro každý úkol nebo vlákno reagovat na zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-112">Provide a mechanism for each task or thread to respond to cancellation.</span></span>  
  
- <span data-ttu-id="92b47-113">Volání <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> metodu k dispozici oznámení o zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-113">Call the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method to provide notification of cancellation.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="92b47-114"><xref:System.Threading.CancellationTokenSource> Implementuje třída <xref:System.IDisposable> rozhraní.</span><span class="sxs-lookup"><span data-stu-id="92b47-114">The <xref:System.Threading.CancellationTokenSource> class implements the <xref:System.IDisposable> interface.</span></span> <span data-ttu-id="92b47-115">By měl nezapomeňte volat <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> metoda po dokončení používání zdroje tokenu zrušení uvolnit žádné nespravované prostředky, které obsahuje.</span><span class="sxs-lookup"><span data-stu-id="92b47-115">You should be sure to call the <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> method when you have finished using the cancellation token source to free any unmanaged resources it holds.</span></span>  
  
 <span data-ttu-id="92b47-116">Následující ilustrace znázorňuje vztah mezi zdrojem tokenu a všechny kopie svůj token.</span><span class="sxs-lookup"><span data-stu-id="92b47-116">The following illustration shows the relationship between a token source and all the copies of its token.</span></span>  
  
 <span data-ttu-id="92b47-117">![CancellationTokenSource – a zrušení tokenů](../../../docs/standard/threading/media/vs-cancellationtoken.png "VS_CancellationToken")</span><span class="sxs-lookup"><span data-stu-id="92b47-117">![CancellationTokenSource and cancellation tokens](../../../docs/standard/threading/media/vs-cancellationtoken.png "VS_CancellationToken")</span></span>  
  
 <span data-ttu-id="92b47-118">Nový model zrušení usnadňuje vytváření aplikací pracujících s zrušení a knihoven a podporuje následující funkce:</span><span class="sxs-lookup"><span data-stu-id="92b47-118">The new cancellation model makes it easier to create cancellation-aware applications and libraries, and it supports the following features:</span></span>  
  
- <span data-ttu-id="92b47-119">Zrušení je spolupráce a nebude se vynucovat na naslouchací proces.</span><span class="sxs-lookup"><span data-stu-id="92b47-119">Cancellation is cooperative and is not forced on the listener.</span></span> <span data-ttu-id="92b47-120">Naslouchací proces určuje, jak v reakci na žádost o zrušení řádně ukončit.</span><span class="sxs-lookup"><span data-stu-id="92b47-120">The listener determines how to gracefully terminate in response to a cancellation request.</span></span>  
  
- <span data-ttu-id="92b47-121">Požaduje se liší od naslouchání.</span><span class="sxs-lookup"><span data-stu-id="92b47-121">Requesting is distinct from listening.</span></span> <span data-ttu-id="92b47-122">Objekt, který vyvolá zrušitelnou operaci můžete řídit, kdy (Pokud) je požadováno zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-122">An object that invokes a cancelable operation can control when (if ever) cancellation is requested.</span></span>  
  
- <span data-ttu-id="92b47-123">Žádost o objekt vydá požadavek na zrušení u všech kopií token s použitím pouze jedné metody volání.</span><span class="sxs-lookup"><span data-stu-id="92b47-123">The requesting object issues the cancellation request to all copies of the token by using just one method call.</span></span>  
  
- <span data-ttu-id="92b47-124">Naslouchací proces mohl naslouchat více tokenů současně jejich sloučením do jedné *propojené token*.</span><span class="sxs-lookup"><span data-stu-id="92b47-124">A listener can listen to multiple tokens simultaneously by joining them into one *linked token*.</span></span>  
  
- <span data-ttu-id="92b47-125">Uživatelský kód můžete zaznamenat a odpovědět na požadavky zrušení z knihovny kódu a kód knihovny můžete zaznamenat a odpovědět na požadavky zrušení z uživatelského kódu.</span><span class="sxs-lookup"><span data-stu-id="92b47-125">User code can notice and respond to cancellation requests from library code, and library code can notice and respond to cancellation requests from user code.</span></span>  
  
- <span data-ttu-id="92b47-126">Naslouchací procesy můžete dostávat oznámení žádostí o zrušení dotazování, registrace zpětného volání a čekání na obslužné rutiny čekání.</span><span class="sxs-lookup"><span data-stu-id="92b47-126">Listeners can be notified of cancellation requests by polling, callback registration, or waiting on wait handles.</span></span>  
  
## <a name="cancellation-types"></a><span data-ttu-id="92b47-127">Typy zrušení</span><span class="sxs-lookup"><span data-stu-id="92b47-127">Cancellation Types</span></span>  
 <span data-ttu-id="92b47-128">Zrušení framework je implementované jako sada souvisejících typů, které jsou uvedeny v následující tabulce.</span><span class="sxs-lookup"><span data-stu-id="92b47-128">The cancellation framework is implemented as a set of related types, which are listed in the following table.</span></span>  
  
|<span data-ttu-id="92b47-129">Název typu</span><span class="sxs-lookup"><span data-stu-id="92b47-129">Type name</span></span>|<span data-ttu-id="92b47-130">Popis</span><span class="sxs-lookup"><span data-stu-id="92b47-130">Description</span></span>|  
|---------------|-----------------|  
|<xref:System.Threading.CancellationTokenSource>|<span data-ttu-id="92b47-131">Objekt, který vytvoří token zrušení a také vystaví žádost o zrušení pro všechny kopie tohoto tokenu.</span><span class="sxs-lookup"><span data-stu-id="92b47-131">Object that creates a cancellation token, and also issues the cancellation request for all copies of that token.</span></span>|  
|<xref:System.Threading.CancellationToken>|<span data-ttu-id="92b47-132">Zjednodušené hodnotu předán typ na jeden nebo více naslouchacích procesů, obvykle jako parametr metody.</span><span class="sxs-lookup"><span data-stu-id="92b47-132">Lightweight value type passed to one or more listeners, typically as a method parameter.</span></span> <span data-ttu-id="92b47-133">Naslouchací procesy monitorování hodnoty `IsCancellationRequested` vlastnost tokenu dotazování, zpětné volání nebo popisovač čekání.</span><span class="sxs-lookup"><span data-stu-id="92b47-133">Listeners monitor the value of the `IsCancellationRequested` property of the token by polling, callback, or wait handle.</span></span>|  
|<xref:System.OperationCanceledException>|<span data-ttu-id="92b47-134">Přetížení konstruktoru tuto výjimku přijmout <xref:System.Threading.CancellationToken> jako parametr.</span><span class="sxs-lookup"><span data-stu-id="92b47-134">Overloads of this exception's constructor accept a <xref:System.Threading.CancellationToken> as a parameter.</span></span> <span data-ttu-id="92b47-135">Naslouchacích procesů může volitelně vyvolat tuto výjimku ověřit zdroj zrušení a informovat ostatní, které odpověděl na požadavek na zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-135">Listeners can optionally throw this exception to verify the source of the cancellation and notify others that it has responded to a cancellation request.</span></span>|  
  
 <span data-ttu-id="92b47-136">Nový model zrušení je integrovaná [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] v několika typech.</span><span class="sxs-lookup"><span data-stu-id="92b47-136">The new cancellation model is integrated into the [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] in several types.</span></span> <span data-ttu-id="92b47-137">Nejdůležitější ty jsou <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> a <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="92b47-137">The most important ones are <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span></span> <span data-ttu-id="92b47-138">Doporučujeme použít tento nový model zrušení pro všechny nové kód knihovny a aplikace.</span><span class="sxs-lookup"><span data-stu-id="92b47-138">We recommend that you use this new cancellation model for all new library and application code.</span></span>  
  
## <a name="code-example"></a><span data-ttu-id="92b47-139">Příklad kódu</span><span class="sxs-lookup"><span data-stu-id="92b47-139">Code Example</span></span>  
 <span data-ttu-id="92b47-140">V následujícím příkladu se vytvoří žádost o objekt <xref:System.Threading.CancellationTokenSource> objektu a předává jeho <xref:System.Threading.CancellationTokenSource.Token%2A> vlastnost zrušitelnou operaci.</span><span class="sxs-lookup"><span data-stu-id="92b47-140">In the following example, the requesting object creates a <xref:System.Threading.CancellationTokenSource> object, and then passes its <xref:System.Threading.CancellationTokenSource.Token%2A> property to the cancelable operation.</span></span> <span data-ttu-id="92b47-141">Operace, která obdrží požadavek monitoruje hodnotu <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> vlastnost tokenu cyklického dotazování.</span><span class="sxs-lookup"><span data-stu-id="92b47-141">The operation that receives the request monitors the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token by polling.</span></span> <span data-ttu-id="92b47-142">Pokud tato hodnota začne `true`, můžete ve svých ukončí naslouchací proces.</span><span class="sxs-lookup"><span data-stu-id="92b47-142">When the value becomes `true`, the listener can terminate in whatever manner is appropriate.</span></span> <span data-ttu-id="92b47-143">V tomto příkladu metoda právě ukončí, což je vše, co je nutné v mnoha případech.</span><span class="sxs-lookup"><span data-stu-id="92b47-143">In this example, the method just exits, which is all that is required in many cases.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="92b47-144">V příkladu se používá <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> metoda prokázat, že je kompatibilní s starší verze rozhraní API rozhraní nové zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-144">The example uses the <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> method to demonstrate that the new cancellation framework is compatible with legacy APIs.</span></span> <span data-ttu-id="92b47-145">Příklad, který používá nový, upřednostňované <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> zadejte naleznete v tématu [jak: Zrušení úlohy a jejích potomků](../../../docs/standard/parallel-programming/how-to-cancel-a-task-and-its-children.md).</span><span class="sxs-lookup"><span data-stu-id="92b47-145">For an example that uses the new, preferred <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> type, see [How to: Cancel a Task and Its Children](../../../docs/standard/parallel-programming/how-to-cancel-a-task-and-its-children.md).</span></span>  
  
 [!code-csharp[Cancellation#1](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex1.cs#1)]
 [!code-vb[Cancellation#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex1.vb#1)]  
  
## <a name="operation-cancellation-versus-object-cancellation"></a><span data-ttu-id="92b47-146">Operace zrušení a zrušení objektu</span><span class="sxs-lookup"><span data-stu-id="92b47-146">Operation Cancellation Versus Object Cancellation</span></span>  
 <span data-ttu-id="92b47-147">V rámci nové zrušení zrušení odkazuje na operace, ne objekty.</span><span class="sxs-lookup"><span data-stu-id="92b47-147">In the new cancellation framework, cancellation refers to operations, not objects.</span></span> <span data-ttu-id="92b47-148">Žádost o zrušení znamená, že by se měla operaci zastavit co nejdříve po provedení všechny potřebné vyčištění.</span><span class="sxs-lookup"><span data-stu-id="92b47-148">The cancellation request means that the operation should stop as soon as possible after any required cleanup is performed.</span></span> <span data-ttu-id="92b47-149">Jeden token zrušení by měla odkazovat na jeden "zrušitelnou operaci,", ale tuto operaci mohou být implementovány v aplikaci.</span><span class="sxs-lookup"><span data-stu-id="92b47-149">One cancellation token should refer to one "cancelable operation," however that operation may be implemented in your program.</span></span> <span data-ttu-id="92b47-150">Po <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> vlastnost tokenu je nastavená na `true`, nelze jej obnovit do `false`.</span><span class="sxs-lookup"><span data-stu-id="92b47-150">After the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token has been set to `true`, it cannot be reset to `false`.</span></span> <span data-ttu-id="92b47-151">Proto tokeny zrušení nemůže být znovu použité po byla zrušena.</span><span class="sxs-lookup"><span data-stu-id="92b47-151">Therefore, cancellation tokens cannot be reused after they have been canceled.</span></span>  
  
 <span data-ttu-id="92b47-152">Pokud budete potřebovat mechanismus zrušení objektu, můžete založit ho na mechanismu zrušení operace voláním <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType> způsob, jak je znázorněno v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="92b47-152">If you require an object cancellation mechanism, you can base it on the operation cancellation mechanism by calling the <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType> method, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#2](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/objectcancellation1.cs#2)]
 [!code-vb[Cancellation#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/objectcancellation1.vb#2)]  
  
 <span data-ttu-id="92b47-153">Pokud objekt podporuje víc souběžných zrušitelnou operaci, předejte samostatný token jako vstup pro každý jedinečných zrušitelnou operaci.</span><span class="sxs-lookup"><span data-stu-id="92b47-153">If an object supports more than one concurrent cancelable operation, pass a separate token as input to each distinct cancelable operation.</span></span> <span data-ttu-id="92b47-154">Tímto způsobem, aniž by to ovlivnilo ostatní lze zrušit jednu operaci.</span><span class="sxs-lookup"><span data-stu-id="92b47-154">That way, one operation can be cancelled without affecting the others.</span></span>  
  
## <a name="listening-and-responding-to-cancellation-requests"></a><span data-ttu-id="92b47-155">Naslouchání a reagovat na požadavky zrušení</span><span class="sxs-lookup"><span data-stu-id="92b47-155">Listening and Responding to Cancellation Requests</span></span>  
 <span data-ttu-id="92b47-156">Implementátor zrušitelnou operaci v uživatelském delegátu, určuje, jak ukončit operaci v reakci na žádost o zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-156">In the user delegate, the implementer of a cancelable operation determines how to terminate the operation in response to a cancellation request.</span></span> <span data-ttu-id="92b47-157">V mnoha případech můžete uživatelský delegát provést všechny potřebné vyčištění a vrátíte se okamžitě.</span><span class="sxs-lookup"><span data-stu-id="92b47-157">In many cases, the user delegate can just perform any required cleanup and then return immediately.</span></span>  
  
 <span data-ttu-id="92b47-158">Nicméně v složitějších případech bude pravděpodobně nutné pro uživatelský delegát oznámit kód knihovny, který má došlo ke zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-158">However, in more complex cases, it might be necessary for the user delegate to notify library code that cancellation has occurred.</span></span> <span data-ttu-id="92b47-159">V takovém případě je správný způsob ukončení operace pro delegáta pro volání <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, metodu, která způsobí, že <xref:System.OperationCanceledException> vyvolání.</span><span class="sxs-lookup"><span data-stu-id="92b47-159">In such cases, the correct way to terminate the operation is for the delegate to call the <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, method, which will cause an <xref:System.OperationCanceledException> to be thrown.</span></span> <span data-ttu-id="92b47-160">Kód knihovny můžete tuto výjimku zachytit na vlákně uživatelského delegáta a zkontrolujte token této výjimky k určení, zda výjimku označuje kooperativní zrušení nebo některé jiné výjimečné situace.</span><span class="sxs-lookup"><span data-stu-id="92b47-160">Library code can catch this exception on the user delegate thread and examine the exception's token to determine whether the exception indicates cooperative cancellation or some other exceptional situation.</span></span>  
  
 <span data-ttu-id="92b47-161"><xref:System.Threading.Tasks.Task> Třídy obslužné rutiny <xref:System.OperationCanceledException> tímto způsobem.</span><span class="sxs-lookup"><span data-stu-id="92b47-161">The <xref:System.Threading.Tasks.Task> class handles <xref:System.OperationCanceledException> in this way.</span></span> <span data-ttu-id="92b47-162">Další informace najdete v tématu [zrušení úlohy](../../../docs/standard/parallel-programming/task-cancellation.md).</span><span class="sxs-lookup"><span data-stu-id="92b47-162">For more information, see [Task Cancellation](../../../docs/standard/parallel-programming/task-cancellation.md).</span></span>  
  
### <a name="listening-by-polling"></a><span data-ttu-id="92b47-163">Naslouchání cyklického dotazování</span><span class="sxs-lookup"><span data-stu-id="92b47-163">Listening by Polling</span></span>  
 <span data-ttu-id="92b47-164">Pro dlouhodobé výpočtů tuto smyčku nebo recurse, může naslouchat pro žádost o zrušení pomocí pravidelně cyklického dotazování hodnotu <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType> vlastnost.</span><span class="sxs-lookup"><span data-stu-id="92b47-164">For long-running computations that loop or recurse, you can listen for a cancellation request by periodically polling the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="92b47-165">Pokud je jeho hodnota `true`, metoda by měla vyčistit a ukončit tak rychle.</span><span class="sxs-lookup"><span data-stu-id="92b47-165">If its value is `true`, the method should clean up and terminate as quickly as possible.</span></span> <span data-ttu-id="92b47-166">Optimální frekvence cyklického dotazování závisí na typu aplikace.</span><span class="sxs-lookup"><span data-stu-id="92b47-166">The optimal frequency of polling depends on the type of application.</span></span> <span data-ttu-id="92b47-167">Je pro vývojáře k určení nejlepší četnost pro libovolný daný program dotazování.</span><span class="sxs-lookup"><span data-stu-id="92b47-167">It is up to the developer to determine the best polling frequency for any given program.</span></span> <span data-ttu-id="92b47-168">Dotazování samotný není výrazně ovlivnit výkon.</span><span class="sxs-lookup"><span data-stu-id="92b47-168">Polling itself does not significantly impact performance.</span></span> <span data-ttu-id="92b47-169">Následující příklad ukazuje jeden možný způsob, jak dotazovat.</span><span class="sxs-lookup"><span data-stu-id="92b47-169">The following example shows one possible way to poll.</span></span>  
  
 [!code-csharp[Cancellation#3](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex11.cs#3)]
 [!code-vb[Cancellation#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex11.vb#3)]  
  
 <span data-ttu-id="92b47-170">Podrobnější příklad naleznete v tématu [jak: Naslouchání požadavkům zrušení dotazováním](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-by-polling.md).</span><span class="sxs-lookup"><span data-stu-id="92b47-170">For a more complete example, see [How to: Listen for Cancellation Requests by Polling](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-by-polling.md).</span></span>  
  
### <a name="listening-by-registering-a-callback"></a><span data-ttu-id="92b47-171">Naslouchání tak, že zaregistrujete zpětné volání</span><span class="sxs-lookup"><span data-stu-id="92b47-171">Listening by Registering a Callback</span></span>  
 <span data-ttu-id="92b47-172">Některé operace můžou tak, že se nelze vrátit hodnota tokenu zrušení se změnami tak včas nereflektují zablokování.</span><span class="sxs-lookup"><span data-stu-id="92b47-172">Some operations can become blocked in such a way that they cannot check the value of the cancellation token in a timely manner.</span></span> <span data-ttu-id="92b47-173">Pro tyto případy můžete zaregistrovat metodu zpětného volání, která se odblokuje metodu, když je obdržena žádost o zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-173">For these cases, you can register a callback method that unblocks the method when a cancellation request is received.</span></span>  
  
 <span data-ttu-id="92b47-174"><xref:System.Threading.CancellationToken.Register%2A> Metoda vrátí hodnotu <xref:System.Threading.CancellationTokenRegistration> objekt, který je speciálně pro tento účel použít.</span><span class="sxs-lookup"><span data-stu-id="92b47-174">The <xref:System.Threading.CancellationToken.Register%2A> method returns a <xref:System.Threading.CancellationTokenRegistration> object that is used specifically for this purpose.</span></span> <span data-ttu-id="92b47-175">Následující příklad ukazuje způsob použití <xref:System.Threading.CancellationToken.Register%2A> metodu zrušení asynchronní webový požadavek.</span><span class="sxs-lookup"><span data-stu-id="92b47-175">The following example shows how to use the <xref:System.Threading.CancellationToken.Register%2A> method to cancel an asynchronous Web request.</span></span>  
  
 [!code-csharp[Cancellation#4](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex4.cs#4)]
 [!code-vb[Cancellation#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex4.vb#4)]  
  
 <span data-ttu-id="92b47-176"><xref:System.Threading.CancellationTokenRegistration> Objekt spravuje synchronizaci vláken a zajistí, že zpětné volání se zastaví provádění na konkrétním místě v čase.</span><span class="sxs-lookup"><span data-stu-id="92b47-176">The <xref:System.Threading.CancellationTokenRegistration> object manages thread synchronization and ensures that the callback will stop executing at a precise point in time.</span></span>  
  
 <span data-ttu-id="92b47-177">Aby bylo možné zajistit rychlost odezvy systému a aby se zabránilo zablokování podle následujících pokynů musí následovat při registraci zpětná volání:</span><span class="sxs-lookup"><span data-stu-id="92b47-177">In order to ensure system responsiveness and to avoid deadlocks, the following guidelines must be followed when registering callbacks:</span></span>  
  
- <span data-ttu-id="92b47-178">Metoda zpětného volání by mělo být rychle, protože je volána synchronně a proto volání <xref:System.Threading.CancellationTokenSource.Cancel%2A> nevrací až do zpětného volání vrátí.</span><span class="sxs-lookup"><span data-stu-id="92b47-178">The callback method should be fast because it is called synchronously and therefore the call to <xref:System.Threading.CancellationTokenSource.Cancel%2A> does not return until the callback returns.</span></span>  
  
- <span data-ttu-id="92b47-179">Při volání <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> zpětného volání je spuštěn a uchování, která zpětné volání čeká na zámek, váš program může zablokování.</span><span class="sxs-lookup"><span data-stu-id="92b47-179">If you call <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> while the callback is running, and you hold a lock that the callback is waiting on, your program can deadlock.</span></span> <span data-ttu-id="92b47-180">Po `Dispose` vrátí, můžete uvolnit všechny prostředky vyžadované zpětného volání.</span><span class="sxs-lookup"><span data-stu-id="92b47-180">After `Dispose` returns, you can free any resources required by the callback.</span></span>  
  
- <span data-ttu-id="92b47-181">Zpětná volání neměli provádět jakékoli ruční vlákno nebo <xref:System.Threading.SynchronizationContext> využití ve zpětném volání.</span><span class="sxs-lookup"><span data-stu-id="92b47-181">Callbacks should not perform any manual thread or <xref:System.Threading.SynchronizationContext> usage in a callback.</span></span> <span data-ttu-id="92b47-182">Pokud zpětné volání, musíte spustit na konkrétní vlákno, použijte <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> konstruktor, který vám umožňuje určit, že cíl syncContext je aktivní <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="92b47-182">If a callback must run on a particular thread, use the <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> constructor that enables you to specify that the target syncContext is the active <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="92b47-183">Provádění ruční práce s vlákny ve zpětném volání může způsobit zablokování.</span><span class="sxs-lookup"><span data-stu-id="92b47-183">Performing manual threading in a callback can cause deadlock.</span></span>  
  
 <span data-ttu-id="92b47-184">Podrobnější příklad naleznete v tématu [jak: Registrace zpětných volání pro požadavky zrušení](../../../docs/standard/threading/how-to-register-callbacks-for-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="92b47-184">For a more complete example, see [How to: Register Callbacks for Cancellation Requests](../../../docs/standard/threading/how-to-register-callbacks-for-cancellation-requests.md).</span></span>  
  
### <a name="listening-by-using-a-wait-handle"></a><span data-ttu-id="92b47-185">Naslouchání pomocí popisovač čekání</span><span class="sxs-lookup"><span data-stu-id="92b47-185">Listening by Using a Wait Handle</span></span>  
 <span data-ttu-id="92b47-186">Pokud můžete zablokovat zrušitelnou operaci během čekání v rámci synchronizačního primitiva, jako <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> nebo <xref:System.Threading.Semaphore?displayProperty=nameWithType>, můžete použít <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> vlastností pro povolení operace čekání na události a žádost o zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-186">When a cancelable operation can block while it waits on a synchronization primitive such as a <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> or <xref:System.Threading.Semaphore?displayProperty=nameWithType>, you can use the <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> property to enable the operation to wait on both the event and the cancellation request.</span></span> <span data-ttu-id="92b47-187">Popisovač čekání token zrušení bude stát signalizovanými v reakci na žádost o zrušení a metodu můžete použít na návratový typ <xref:System.Threading.WaitHandle.WaitAny%2A> metodou ke zjištění, zda byla zrušení token, který signál.</span><span class="sxs-lookup"><span data-stu-id="92b47-187">The wait handle of the cancellation token will become signaled in response to a cancellation request, and the method can use the return value of the <xref:System.Threading.WaitHandle.WaitAny%2A> method to determine whether it was the cancellation token that signaled.</span></span> <span data-ttu-id="92b47-188">Operace následně právě ukončete, nebo vyvolat <xref:System.OperationCanceledException>podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="92b47-188">The operation can then just exit, or throw a <xref:System.OperationCanceledException>, as appropriate.</span></span>  
  
 [!code-csharp[Cancellation#5](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex9.cs#5)]
 [!code-vb[Cancellation#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex9.vb#5)]  
  
 <span data-ttu-id="92b47-189">V novém kódu, který se zaměřuje [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> a <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> podporovaly nový rámec zrušení v jejich `Wait` metody.</span><span class="sxs-lookup"><span data-stu-id="92b47-189">In new code that targets the [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> and <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> both support the new cancellation framework in their `Wait` methods.</span></span> <span data-ttu-id="92b47-190">Můžete předat <xref:System.Threading.CancellationToken> metody, a pokud se požaduje zrušení, události probudí a vyvolá výjimku <xref:System.OperationCanceledException>.</span><span class="sxs-lookup"><span data-stu-id="92b47-190">You can pass the <xref:System.Threading.CancellationToken> to the method, and when the cancellation is requested, the event wakes up and throws an <xref:System.OperationCanceledException>.</span></span>  
  
 [!code-csharp[Cancellation#6](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex10.cs#6)]
 [!code-vb[Cancellation#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex10.vb#6)]  
  
 <span data-ttu-id="92b47-191">Podrobnější příklad naleznete v tématu [jak: Naslouchání požadavkům zrušení, které mají obslužné rutiny čekání](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span><span class="sxs-lookup"><span data-stu-id="92b47-191">For a more complete example, see [How to: Listen for Cancellation Requests That Have Wait Handles](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span></span>  
  
### <a name="listening-to-multiple-tokens-simultaneously"></a><span data-ttu-id="92b47-192">Naslouchání současně více tokenů</span><span class="sxs-lookup"><span data-stu-id="92b47-192">Listening to Multiple Tokens Simultaneously</span></span>  
 <span data-ttu-id="92b47-193">V některých případech může mít naslouchací proces nenaslouchá na více tokenů zrušení současně.</span><span class="sxs-lookup"><span data-stu-id="92b47-193">In some cases, a listener may have to listen to multiple cancellation tokens simultaneously.</span></span> <span data-ttu-id="92b47-194">Například může mít zrušitelnou operaci monitorování token zrušení interní kromě token předaný externě jako argument pro parametr metody.</span><span class="sxs-lookup"><span data-stu-id="92b47-194">For example, a cancelable operation may have to monitor an internal cancellation token in addition to a token passed in externally as an argument to a method parameter.</span></span> <span data-ttu-id="92b47-195">K tomu vytvořte zdroj propojené token, který se můžete zapojit do dvou nebo více tokenů do jednoho tokenu, jak je znázorněno v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="92b47-195">To accomplish this, create a linked token source that can join two or more tokens into one token, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#7](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex13.cs#7)]
 [!code-vb[Cancellation#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex13.vb#7)]  
  
 <span data-ttu-id="92b47-196">Všimněte si, že je nutné volat `Dispose` na propojený zdroj tokenu, až budete hotovi s ním.</span><span class="sxs-lookup"><span data-stu-id="92b47-196">Notice that you must call `Dispose` on the linked token source when you are done with it.</span></span> <span data-ttu-id="92b47-197">Podrobnější příklad naleznete v tématu [jak: Naslouchání více požadavkům zrušení](../../../docs/standard/threading/how-to-listen-for-multiple-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="92b47-197">For a more complete example, see [How to: Listen for Multiple Cancellation Requests](../../../docs/standard/threading/how-to-listen-for-multiple-cancellation-requests.md).</span></span>  
  
## <a name="cooperation-between-library-code-and-user-code"></a><span data-ttu-id="92b47-198">Spolupráce mezi kód knihovny a kód uživatele</span><span class="sxs-lookup"><span data-stu-id="92b47-198">Cooperation Between Library Code and User Code</span></span>  
 <span data-ttu-id="92b47-199">Rozhraní unified zrušení umožňuje kód knihovny zrušit uživatelský kód a kód uživatele zrušit kód knihovny na způsob spolupráce za.</span><span class="sxs-lookup"><span data-stu-id="92b47-199">The unified cancellation framework makes it possible for library code to cancel user code, and for user code to cancel library code in a cooperative manner.</span></span> <span data-ttu-id="92b47-200">Smooth spolupráce, závisí na každé straně držet těchto pokynů:</span><span class="sxs-lookup"><span data-stu-id="92b47-200">Smooth cooperation depends on each side following these guidelines:</span></span>  
  
- <span data-ttu-id="92b47-201">Pokud kód knihovny poskytuje operace zaslána, měl by také poskytovat veřejné metody, které přijímají token zrušení externí tak, aby uživatelský kód, můžete požádat o zrušení.</span><span class="sxs-lookup"><span data-stu-id="92b47-201">If library code provides cancelable operations, it should also provide public methods that accept an external cancellation token so that user code can request cancellation.</span></span>  
  
- <span data-ttu-id="92b47-202">Volá-li kód knihovny do uživatelského kódu, kód knihovny by měl interpretovat OperationCanceledException(externalToken) jako *kooperativní zrušení*a nikoli jako výjimky na chyby.</span><span class="sxs-lookup"><span data-stu-id="92b47-202">If library code calls into user code, the library code should interpret an OperationCanceledException(externalToken) as *cooperative cancellation*, and not necessarily as a failure exception.</span></span>  
  
- <span data-ttu-id="92b47-203">Uživatelské delegáty mají pokusit odpovědět na požadavky zrušení z kódu knihovny včas.</span><span class="sxs-lookup"><span data-stu-id="92b47-203">User-delegates should attempt to respond to cancellation requests from library code in a timely manner.</span></span>  
  
 <span data-ttu-id="92b47-204"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> a <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> jsou příklady tříd, které postupujte podle následujících pokynů.</span><span class="sxs-lookup"><span data-stu-id="92b47-204"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> are examples of classes that follow these guidelines.</span></span> <span data-ttu-id="92b47-205">Další informace najdete v tématu [zrušení úlohy](../../../docs/standard/parallel-programming/task-cancellation.md) a [jak: Zrušení dotazu PLINQ](../../../docs/standard/parallel-programming/how-to-cancel-a-plinq-query.md).</span><span class="sxs-lookup"><span data-stu-id="92b47-205">For more information, see [Task Cancellation](../../../docs/standard/parallel-programming/task-cancellation.md) and [How to: Cancel a PLINQ Query](../../../docs/standard/parallel-programming/how-to-cancel-a-plinq-query.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="92b47-206">Viz také:</span><span class="sxs-lookup"><span data-stu-id="92b47-206">See also</span></span>

- [<span data-ttu-id="92b47-207">Základy dělení na spravovaná vlákna</span><span class="sxs-lookup"><span data-stu-id="92b47-207">Managed Threading Basics</span></span>](../../../docs/standard/threading/managed-threading-basics.md)
