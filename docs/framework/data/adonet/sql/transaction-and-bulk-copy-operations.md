---
title: Operace transakcí a hromadného kopírování
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: f30974e020545a69ad20c03bc05ac6a28f289b01
ms.sourcegitcommit: 5b6d778ebb269ee6684fb57ad69a8c28b06235b9
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 04/08/2019
ms.locfileid: "59074622"
---
# <a name="transaction-and-bulk-copy-operations"></a><span data-ttu-id="f6da9-102">Operace transakcí a hromadného kopírování</span><span class="sxs-lookup"><span data-stu-id="f6da9-102">Transaction and Bulk Copy Operations</span></span>
<span data-ttu-id="f6da9-103">Operace hromadného kopírování lze provést jako izolované operace nebo jako součást více transakcí kroku.</span><span class="sxs-lookup"><span data-stu-id="f6da9-103">Bulk copy operations can be performed as isolated operations or as part of a multiple step transaction.</span></span> <span data-ttu-id="f6da9-104">Tato druhou možnost umožňuje provádět více než jednu operaci hromadného kopírování v rámci jedné transakce a také provádění jiných operací databáze (například vložení, aktualizace a odstranění), ale stále mít možnost potvrzení nebo vrácení zpět celou transakci.</span><span class="sxs-lookup"><span data-stu-id="f6da9-104">This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.</span></span>  
  
 <span data-ttu-id="f6da9-105">Ve výchozím nastavení se provádí operaci hromadného kopírování jako izolované operace.</span><span class="sxs-lookup"><span data-stu-id="f6da9-105">By default, a bulk copy operation is performed as an isolated operation.</span></span> <span data-ttu-id="f6da9-106">Dojde k operaci hromadného kopírování tak beztransakční nebude mít možnost vrácení zpět.</span><span class="sxs-lookup"><span data-stu-id="f6da9-106">The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back.</span></span> <span data-ttu-id="f6da9-107">Pokud je potřeba vrátit zpět nebo její část hromadného kopírování při výskytu chyby, můžete použít <xref:System.Data.SqlClient.SqlBulkCopy>– spravované transakce, proveďte operaci hromadného kopírování v rámci existující transakce nebo být uveden v **System.Transactions** <xref:System.Transactions.Transaction>.</span><span class="sxs-lookup"><span data-stu-id="f6da9-107">If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>.</span></span>  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a><span data-ttu-id="f6da9-108">Provádění beztransakční hromadného kopírování</span><span class="sxs-lookup"><span data-stu-id="f6da9-108">Performing a Non-transacted Bulk Copy Operation</span></span>  
 <span data-ttu-id="f6da9-109">Následující konzolové aplikace ukazuje, co se stane, když beztransakční hromadného kopírování dojde k chybě partway prostřednictvím operace.</span><span class="sxs-lookup"><span data-stu-id="f6da9-109">The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.</span></span>  
  
 <span data-ttu-id="f6da9-110">V příkladu se zdrojové tabulky a cílová tabulka zahrnují `Identity` sloupec s názvem **ProductID**.</span><span class="sxs-lookup"><span data-stu-id="f6da9-110">In the example, the source table and destination table each include an `Identity` column named **ProductID**.</span></span> <span data-ttu-id="f6da9-111">Kód nejprve připraví cílové tabulky tak, že odstraníte všechny řádky a následného vložení jeden řádek, jehož **ProductID** se ví, že existují ve zdrojové tabulce.</span><span class="sxs-lookup"><span data-stu-id="f6da9-111">The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table.</span></span> <span data-ttu-id="f6da9-112">Ve výchozím nastavení, novou hodnotu `Identity` sloupec je vygenerována v cílové tabulce pro každý řádek přidán.</span><span class="sxs-lookup"><span data-stu-id="f6da9-112">By default, a new value for the `Identity` column is generated in the destination table for each row added.</span></span> <span data-ttu-id="f6da9-113">V tomto příkladu je nastavena možnost, když je otevřeno připojení, která vynutí procesu hromadného načtení použít `Identity` místo hodnoty ze zdrojové tabulky.</span><span class="sxs-lookup"><span data-stu-id="f6da9-113">In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead.</span></span>  
  
 <span data-ttu-id="f6da9-114">Pomocí provádí se operace hromadného kopírování <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> vlastnost nastavená na hodnotu 10.</span><span class="sxs-lookup"><span data-stu-id="f6da9-114">The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10.</span></span> <span data-ttu-id="f6da9-115">Při operaci zjistí neplatný řádek, je vyvolána výjimka.</span><span class="sxs-lookup"><span data-stu-id="f6da9-115">When the operation encounters the invalid row, an exception is thrown.</span></span> <span data-ttu-id="f6da9-116">V tomto příkladu první operaci hromadného kopírování je, která nepodporuje transakce.</span><span class="sxs-lookup"><span data-stu-id="f6da9-116">In this first example, the bulk copy operation is non-transacted.</span></span> <span data-ttu-id="f6da9-117">Všechny listy zkopírovat až do chvíle, chyby jsou potvrzeny; dávka obsahuje duplicitní klíč se vrátí zpět, a operaci hromadného kopírování je zastaven před zpracováním jiných dávky.</span><span class="sxs-lookup"><span data-stu-id="f6da9-117">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="f6da9-118">Tato ukázka se nespustí, pokud jste vytvořili pracovní tabulky, jak je popsáno v [příklad nastavení hromadného kopírování](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="f6da9-118">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="f6da9-119">Tento kód je k dispozici k předvedení syntaxe pro používání **SqlBulkCopy** pouze.</span><span class="sxs-lookup"><span data-stu-id="f6da9-119">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="f6da9-120">Pokud zdrojové a cílové tabulky jsou umístěny ve stejné instanci systému SQL Server, je jednodušší a rychlejší je použít [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` příkaz Kopírovat data.</span><span class="sxs-lookup"><span data-stu-id="f6da9-120">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a><span data-ttu-id="f6da9-121">Provádění vyhrazené hromadného kopírování v transakci</span><span class="sxs-lookup"><span data-stu-id="f6da9-121">Performing a Dedicated Bulk Copy Operation in a Transaction</span></span>  
 <span data-ttu-id="f6da9-122">Ve výchozím nastavení je operaci hromadného kopírování vlastní transakce.</span><span class="sxs-lookup"><span data-stu-id="f6da9-122">By default, a bulk copy operation is its own transaction.</span></span> <span data-ttu-id="f6da9-123">Pokud chcete provést vyhrazené hromadného kopírování, vytvořte novou instanci třídy <xref:System.Data.SqlClient.SqlBulkCopy> pomocí připojovacího řetězce, nebo použít existující <xref:System.Data.SqlClient.SqlConnection> objekt bez aktivní transakce.</span><span class="sxs-lookup"><span data-stu-id="f6da9-123">When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction.</span></span> <span data-ttu-id="f6da9-124">V každém scénáři operaci hromadného kopírování vytvoří a potom potvrzení nebo vrátí zpět transakce.</span><span class="sxs-lookup"><span data-stu-id="f6da9-124">In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.</span></span>  
  
 <span data-ttu-id="f6da9-125">Můžete explicitně určit <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> možnost <xref:System.Data.SqlClient.SqlBulkCopy> konstruktoru třídy explicitně vyvolat operaci hromadného kopírování pro spuštění ve své vlastní transakce, způsobí každé dávky operaci hromadného kopírování ke spuštění v rámci samostatných transakcích.</span><span class="sxs-lookup"><span data-stu-id="f6da9-125">You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="f6da9-126">Protože různé listy jsou provedeny v různých transakcí, pokud dojde k chybě při operaci hromadného kopírování, bude vrácena zpět všechny řádky do aktuální dávky, ale řádky z předchozích dávek zůstanou v databázi.</span><span class="sxs-lookup"><span data-stu-id="f6da9-126">Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.</span></span>  
  
 <span data-ttu-id="f6da9-127">Následující konzolové aplikace je podobný jako předchozí příklad s jednou výjimkou: V tomto příkladu operaci hromadného kopírování spravuje svou vlastní transakce.</span><span class="sxs-lookup"><span data-stu-id="f6da9-127">The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions.</span></span> <span data-ttu-id="f6da9-128">Všechny listy zkopírovat až do chvíle, chyby jsou potvrzeny; dávka obsahuje duplicitní klíč se vrátí zpět, a operaci hromadného kopírování je zastaven před zpracováním jiných dávky.</span><span class="sxs-lookup"><span data-stu-id="f6da9-128">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="f6da9-129">Tato ukázka se nespustí, pokud jste vytvořili pracovní tabulky, jak je popsáno v [příklad nastavení hromadného kopírování](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="f6da9-129">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="f6da9-130">Tento kód je k dispozici k předvedení syntaxe pro používání **SqlBulkCopy** pouze.</span><span class="sxs-lookup"><span data-stu-id="f6da9-130">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="f6da9-131">Pokud zdrojové a cílové tabulky jsou umístěny ve stejné instanci systému SQL Server, je jednodušší a rychlejší je použít [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` příkaz Kopírovat data.</span><span class="sxs-lookup"><span data-stu-id="f6da9-131">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a><span data-ttu-id="f6da9-132">Použití existující transakce</span><span class="sxs-lookup"><span data-stu-id="f6da9-132">Using Existing Transactions</span></span>  
 <span data-ttu-id="f6da9-133">Můžete zadat existující <xref:System.Data.SqlClient.SqlTransaction> objektu jako parametr <xref:System.Data.SqlClient.SqlBulkCopy> konstruktoru.</span><span class="sxs-lookup"><span data-stu-id="f6da9-133">You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span> <span data-ttu-id="f6da9-134">V takovém případě se provádí operaci hromadného kopírování v existující transakce a se neprovedly žádné změny stavu transakce (to znamená, ho potvrzené ani přerušen).</span><span class="sxs-lookup"><span data-stu-id="f6da9-134">In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted).</span></span> <span data-ttu-id="f6da9-135">Díky tomu aplikace, aby zahrnovala operaci hromadného kopírování v rámci transakce s dalšími operacemi databáze.</span><span class="sxs-lookup"><span data-stu-id="f6da9-135">This allows an application to include the bulk copy operation in a transaction with other database operations.</span></span> <span data-ttu-id="f6da9-136">Nicméně pokud není zadán <xref:System.Data.SqlClient.SqlTransaction> objektu a předejte jí odkaz s hodnotou null a připojení má aktivní transakce, je vyvolána výjimka.</span><span class="sxs-lookup"><span data-stu-id="f6da9-136">However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown.</span></span>  
  
 <span data-ttu-id="f6da9-137">Pokud je potřeba vrátit zpět, celý hromadné operace kopírování, protože dojde k chybě nebo pokud hromadného kopírování by měly spouštět jako součást většího procesu, který může být vrácena zpět, můžete zadat <xref:System.Data.SqlClient.SqlTransaction> objektu <xref:System.Data.SqlClient.SqlBulkCopy> konstruktoru.</span><span class="sxs-lookup"><span data-stu-id="f6da9-137">If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span>  
  
 <span data-ttu-id="f6da9-138">Následující aplikace konzoly je podobná první (beztransakční) příklad, s jednou výjimkou: v tomto příkladu operaci hromadného kopírování je součástí větší, externí transakci.</span><span class="sxs-lookup"><span data-stu-id="f6da9-138">The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction.</span></span> <span data-ttu-id="f6da9-139">Když dojde k chybě porušení primárního klíče, celá transakce bude vrácena zpět a žádné řádky se přidají do cílové tabulky.</span><span class="sxs-lookup"><span data-stu-id="f6da9-139">When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="f6da9-140">Tato ukázka se nespustí, pokud jste vytvořili pracovní tabulky, jak je popsáno v [příklad nastavení hromadného kopírování](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="f6da9-140">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="f6da9-141">Tento kód je k dispozici k předvedení syntaxe pro používání **SqlBulkCopy** pouze.</span><span class="sxs-lookup"><span data-stu-id="f6da9-141">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="f6da9-142">Pokud zdrojové a cílové tabulky jsou umístěny ve stejné instanci systému SQL Server, je jednodušší a rychlejší je použít [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` příkaz Kopírovat data.</span><span class="sxs-lookup"><span data-stu-id="f6da9-142">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a><span data-ttu-id="f6da9-143">Viz také:</span><span class="sxs-lookup"><span data-stu-id="f6da9-143">See also</span></span>

- [<span data-ttu-id="f6da9-144">Operace hromadného kopírování na SQL Serveru</span><span class="sxs-lookup"><span data-stu-id="f6da9-144">Bulk Copy Operations in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/bulk-copy-operations-in-sql-server.md)
- [<span data-ttu-id="f6da9-145">ADO.NET spravovaných zprostředkovatelích a datové sady pro vývojáře</span><span class="sxs-lookup"><span data-stu-id="f6da9-145">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
