---
title: Správa relací WIF
ms.date: 03/30/2017
ms.assetid: 98bce126-18a9-401b-b20d-67ee462a5f8a
author: BrucePerlerMS
ms.openlocfilehash: 141eda509530cab1120d519c3cbc94693ef1cc51
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 08/22/2019
ms.locfileid: "69946226"
---
# <a name="wif-session-management"></a><span data-ttu-id="33f55-102">Správa relací WIF</span><span class="sxs-lookup"><span data-stu-id="33f55-102">WIF Session Management</span></span>
<span data-ttu-id="33f55-103">Když se klient poprvé pokusí o přístup k chráněnému prostředku, který je hostovaný předávající stranou, klient se musí nejdřív ověřit ve službě tokenů zabezpečení (STS), která je pro předávající stranu důvěryhodná.</span><span class="sxs-lookup"><span data-stu-id="33f55-103">When a client first tries to access a protected resource that is hosted by a relying party, the client must first authenticate itself to a security token service (STS) that is trusted by the relying party.</span></span> <span data-ttu-id="33f55-104">Služba STS pak vydá token zabezpečení pro klienta.</span><span class="sxs-lookup"><span data-stu-id="33f55-104">The STS then issues a security token to the client.</span></span> <span data-ttu-id="33f55-105">Klient prezentuje tento token předávající straně, což pak udělí klientovi přístup k chráněnému prostředku.</span><span class="sxs-lookup"><span data-stu-id="33f55-105">The client presents this token to the relying party, which then grants the client access to the protected resource.</span></span> <span data-ttu-id="33f55-106">Nechcete však, aby se klient musel znovu ověřit u služby STS pro každý požadavek, zejména proto, že nemusí být ani ve stejném počítači nebo ve stejné doméně jako předávající strana.</span><span class="sxs-lookup"><span data-stu-id="33f55-106">However, you don’t want the client to have to re-authenticate to the STS for each request, especially because it might not even be on the same computer or in the same domain as the relying party.</span></span> <span data-ttu-id="33f55-107">Rozhraní Windows Identity Foundation (WIF) má klienta a předávající stranu místo toho, aby navázala relaci, ve které klient používá token zabezpečení relace ke svému ověření vůči předávající straně pro všechny požadavky po prvním požadavku.</span><span class="sxs-lookup"><span data-stu-id="33f55-107">Instead, Windows Identity Foundation (WIF) has the client and relying party establish a session in which the client uses a session security token to authenticate itself to the relying party for all requests after the first request.</span></span> <span data-ttu-id="33f55-108">Předávající strana může použít token zabezpečení relace, který je uložený v souboru cookie pro rekonstrukci klienta <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="33f55-108">The relying party can use this session security token, which is stored inside a cookie, to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>.</span></span>  
  
 <span data-ttu-id="33f55-109">Služba STS definuje, jaké ověřování musí klient poskytnout.</span><span class="sxs-lookup"><span data-stu-id="33f55-109">The STS defines what authentication the client must provide.</span></span> <span data-ttu-id="33f55-110">Klient ale může mít několik přihlašovacích údajů, se kterými se může sám ověřit ve službě STS.</span><span class="sxs-lookup"><span data-stu-id="33f55-110">However, the client might have multiple credentials with which it can authenticate itself to the STS.</span></span> <span data-ttu-id="33f55-111">Může mít například token z Windows Live, uživatelské jméno a heslo, certifikát a SmartKey.</span><span class="sxs-lookup"><span data-stu-id="33f55-111">For example, it might have a token from Windows Live, a user name and password, a certificate, and a smartkey.</span></span> <span data-ttu-id="33f55-112">V takovém případě STS udělí klientovi několik identit, přičemž každou identitu odpovídá jedné z přihlašovacích údajů, které klient prezentuje.</span><span class="sxs-lookup"><span data-stu-id="33f55-112">In that case, the STS grants the client several identities, with each identity corresponding to one of the credentials that the client presents.</span></span> <span data-ttu-id="33f55-113">Předávající strana může použít jednu nebo více těchto identit, když se rozhodne, jakou úroveň přístupu má klient udělit.</span><span class="sxs-lookup"><span data-stu-id="33f55-113">The relying party can use one or more of these identities when it decides what level of access to grant the client.</span></span>  
  
 <span data-ttu-id="33f55-114">Slouží k rekonstrukci <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>klienta, který obsahuje všechny identity klienta v <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>nástroji. <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="33f55-114">The <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> is used to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>, which contains all of the client’s identities in <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span></span> <span data-ttu-id="33f55-115">Každý <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> v kolekci obsahuje tokeny Bootstrap, které jsou přidruženy k této identitě.</span><span class="sxs-lookup"><span data-stu-id="33f55-115">Each <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> in the collection contains the bootstrap tokens that are associated with that identity.</span></span>  
  
 <span data-ttu-id="33f55-116">Pokud je vydaný nový token relace s ID relace původního tokenu relace, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> neaktualizuje token relace v mezipaměti tokenů.</span><span class="sxs-lookup"><span data-stu-id="33f55-116">If a new session token is issued with the session ID of the original session token, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> does not update the session token in the token cache.</span></span> <span data-ttu-id="33f55-117">Vždy byste měli vytvořit instanci tokenu relace s jedinečným ID relace.</span><span class="sxs-lookup"><span data-stu-id="33f55-117">You should always instantiate a session token with a unique session ID.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="33f55-118">Session. SecurityTokenHandler. ReadToken vyvolá <xref:System.Xml.XmlException> výjimku, pokud obdrží neplatný vstup, například pokud je soubor cookie obsahující token relace poškozený.</span><span class="sxs-lookup"><span data-stu-id="33f55-118">Session.SecurityTokenHandler.ReadToken throws a <xref:System.Xml.XmlException> exception if it receives invalid input; for example, if the cookie that contains the session token is corrupted.</span></span> <span data-ttu-id="33f55-119">Doporučujeme zachytit tuto výjimku a zajistit chování specifické pro aplikaci.</span><span class="sxs-lookup"><span data-stu-id="33f55-119">We recommend that you catch this exception and provide application-specific behavior.</span></span>  
  
 <span data-ttu-id="33f55-120">Pokud chráněná webová stránka obsahuje spoustu prostředků (například malých grafických objektů), které jsou také v chráněné doméně, musí se klient znovu ověřit pro předávající stranu, aby si stáhl každý z těchto prostředků.</span><span class="sxs-lookup"><span data-stu-id="33f55-120">If a protected Web page contains lots of resources (such as small graphics) that are also in the protected domain, the client must re-authenticate itself to the relying party to download each of those resources.</span></span> <span data-ttu-id="33f55-121">Použití tokenu ověřování relace zabraňuje nutnosti ověřovat službu STS pro každý požadavek, ale stále znamená, že se posílá mnoho souborů cookie.</span><span class="sxs-lookup"><span data-stu-id="33f55-121">Use of a session authentication token avoids the need to authenticate to the STS for each request, but it still means that many cookies are being sent over.</span></span> <span data-ttu-id="33f55-122">Je možné nastavit webovou stránku tak, aby se důležitá data a prostředky ukládaly v chráněné doméně, zatímco drobné položky jsou uloženy v nechráněné doméně a propojeny s z hlavní webové stránky.</span><span class="sxs-lookup"><span data-stu-id="33f55-122">You might want to set up the Web page so that the important data and resources are stored in the protected domain while minor items are stored in an unprotected domain and linked to from the main Web page.</span></span> <span data-ttu-id="33f55-123">Také nastavte cestu k souboru cookie tak, aby odkazovala pouze na chráněnou doménu.</span><span class="sxs-lookup"><span data-stu-id="33f55-123">Also, set the cookie path to reference only the protected domain.</span></span>  
  
 <span data-ttu-id="33f55-124">Aby bylo možné pracovat v režimu referenčního režimu, společnost Microsoft doporučuje <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> poskytnout obslužnou rutinu pro událost v souboru **Global.asax.cs** a nastavit vlastnost **IsReferenceMode** tokenu předaného ve <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A> vlastnosti.</span><span class="sxs-lookup"><span data-stu-id="33f55-124">To operate in reference mode, Microsoft recommends providing a handler for the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> event in the **global.asax.cs** file and setting the **IsReferenceMode** property on the token passed in the <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A> property.</span></span> <span data-ttu-id="33f55-125">Tyto aktualizace zajistí, že token relace funguje v referenčním režimu pro každý požadavek a upřednostňuje se pouze nastavením <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> vlastnosti v modulu ověřování relace.</span><span class="sxs-lookup"><span data-stu-id="33f55-125">These updates will ensure that the session token operates in reference mode for every request and is favored over merely setting the  <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> property on the Session Authentication Module.</span></span>  
  
## <a name="extensibility"></a><span data-ttu-id="33f55-126">Rozšiřitelnost</span><span class="sxs-lookup"><span data-stu-id="33f55-126">Extensibility</span></span>  
 <span data-ttu-id="33f55-127">Mechanismus správy relace můžete roztáhnout.</span><span class="sxs-lookup"><span data-stu-id="33f55-127">You can extend the session management mechanism.</span></span> <span data-ttu-id="33f55-128">Jedním z důvodů je zvýšit výkon.</span><span class="sxs-lookup"><span data-stu-id="33f55-128">One reason for this would be to improve the performance.</span></span> <span data-ttu-id="33f55-129">Můžete například vytvořit vlastní obslužnou rutinu souborů cookie, která transformuje nebo optimalizuje token zabezpečení relace mezi stavem v paměti a tím, co přejde do souboru cookie.</span><span class="sxs-lookup"><span data-stu-id="33f55-129">For example, you could create a custom cookie handler that transforms or optimizes the session security token between its in-memory state and what goes into the cookie.</span></span> <span data-ttu-id="33f55-130">Chcete-li to provést, můžete nakonfigurovat <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> vlastnost <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> pro použití vlastní obslužné rutiny souborů cookie, která je odvozena z <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="33f55-130">To do so, you can configure the <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> property of the <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> to use a custom cookie handler that derives from <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span></span> <span data-ttu-id="33f55-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType>je výchozí obslužná rutina souborů cookie, protože soubory cookie překračují povolenou velikost protokolu HTTP (Hypertext Transfer Protocol); Pokud místo toho použijete vlastní obslužnou rutinu souborů cookie, je nutné implementovat bloky dat.</span><span class="sxs-lookup"><span data-stu-id="33f55-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> is the default cookie handler because the cookies exceed the allowable size for Hypertext Transfer Protocol (HTTP); if you use a custom cookie handler instead, you must implement chunking.</span></span>  
  
 <span data-ttu-id="33f55-132">Další informace najdete v tématu [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) Sample.</span><span class="sxs-lookup"><span data-stu-id="33f55-132">For more information, see [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) sample.</span></span> <span data-ttu-id="33f55-133">V této ukázce se zobrazuje mezipaměť připravená pro farmu (na rozdíl od tokenreplycache), abyste mohli používat relace podle referenčních informací namísto výměny velkých souborů cookie. Tato ukázka také demonstruje snazší způsob zabezpečení souborů cookie ve farmě.</span><span class="sxs-lookup"><span data-stu-id="33f55-133">This sample shows a farm ready session cache (as opposed to a tokenreplycache) so that you can use sessions by reference instead of exchanging big cookies; this sample also demonstrates an easier way of securing cookies in a farm.</span></span> <span data-ttu-id="33f55-134">Mezipaměť relace je založená na technologii WCF.</span><span class="sxs-lookup"><span data-stu-id="33f55-134">The session cache is WCF-based.</span></span> <span data-ttu-id="33f55-135">V souvislosti se zabezpečením relací ukazuje ukázka novou funkci v WIF 4,5 transformace souborů cookie založené na MachineKey, kterou lze aktivovat pouhým vložením příslušného fragmentu do souboru Web. config. Samotný vzorek není "Farma", ale ukazuje, co potřebujete k tomu, abyste mohli farmu aplikací připravit.</span><span class="sxs-lookup"><span data-stu-id="33f55-135">With regard to session securing, the sample demonstrates a new capability in WIF 4.5 of a cookie transform based on MachineKey, which can be activated by simply pasting the appropriate snippet in the web.config. The sample itself is not "farmed", but it demonstrates what you need for making your app farm-ready.</span></span>
