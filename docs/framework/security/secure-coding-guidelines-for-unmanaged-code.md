---
title: Pokyny pro zabezpečení nespravovaného kódu
ms.date: 03/30/2017
helpviewer_keywords:
- code security, unmanaged code
- unmanaged code, securing
- security [.NET Framework], unmanaged code
- secure coding, unmanaged code
ms.assetid: a8d15139-d368-4c9c-a747-ba757781117c
author: mairaw
ms.author: mairaw
ms.openlocfilehash: ec97861a9d748767199da3e1fb7f53361c3a48ee
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 08/22/2019
ms.locfileid: "69966126"
---
# <a name="secure-coding-guidelines-for-unmanaged-code"></a><span data-ttu-id="875a6-102">Pokyny pro zabezpečení nespravovaného kódu</span><span class="sxs-lookup"><span data-stu-id="875a6-102">Secure Coding Guidelines for Unmanaged Code</span></span>
<span data-ttu-id="875a6-103">Některé kódy knihoven musí volat do nespravovaného kódu (například rozhraní API nativního kódu, jako je Win32).</span><span class="sxs-lookup"><span data-stu-id="875a6-103">Some library code needs to call into unmanaged code (for example, native code APIs, such as Win32).</span></span> <span data-ttu-id="875a6-104">Vzhledem k tomu, že to znamená mimo hranice zabezpečení pro spravovaný kód, je vyžadována nezbytná opatrnost.</span><span class="sxs-lookup"><span data-stu-id="875a6-104">Because this means going outside the security perimeter for managed code, due caution is required.</span></span> <span data-ttu-id="875a6-105">Pokud je váš kód neutrální z hlediska zabezpečení, musí mít váš kód i jakýkoli kód, který ho volá, oprávnění nespravovaného <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> kódu (<xref:System.Security.Permissions.SecurityPermission> se zadaným příznakem).</span><span class="sxs-lookup"><span data-stu-id="875a6-105">If your code is security-neutral, both your code and any code that calls it must have unmanaged code permission (<xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> flag specified).</span></span>  
  
 <span data-ttu-id="875a6-106">Je však často nevhodné, aby váš volající měl taková výkonná oprávnění.</span><span class="sxs-lookup"><span data-stu-id="875a6-106">However, it is often unreasonable for your caller to have such powerful permissions.</span></span> <span data-ttu-id="875a6-107">V takových případech může být důvěryhodný kód, podobně jako spravovaný obálka nebo kód knihovny popsané v tématu [zabezpečení kódu obálky](../../../docs/framework/misc/securing-wrapper-code.md).</span><span class="sxs-lookup"><span data-stu-id="875a6-107">In such cases, your trusted code can be the go-between, similar to the managed wrapper or library code described in [Securing Wrapper Code](../../../docs/framework/misc/securing-wrapper-code.md).</span></span> <span data-ttu-id="875a6-108">Pokud je základní funkce nespravovaného kódu zcela bezpečná, dá se přímo zveřejnit; v opačném případě se jako první vyžaduje vhodná kontrolní oprávnění (poptávka).</span><span class="sxs-lookup"><span data-stu-id="875a6-108">If the underlying unmanaged code functionality is totally safe, it can be directly exposed; otherwise, a suitable permission check (demand) is required first.</span></span>  
  
 <span data-ttu-id="875a6-109">Když váš kód volá do nespravovaného kódu, ale nechcete, aby volající měli oprávnění pro přístup k nespravovanému kódu, musíte toto právo uplatnit.</span><span class="sxs-lookup"><span data-stu-id="875a6-109">When your code calls into unmanaged code but you do not want to require your callers to have permission to access unmanaged code, you must assert that right.</span></span> <span data-ttu-id="875a6-110">Kontrolní výraz blokuje procházení zásobníku na vašem snímku.</span><span class="sxs-lookup"><span data-stu-id="875a6-110">An assertion blocks the stack walk at your frame.</span></span> <span data-ttu-id="875a6-111">Musíte mít pozor, abyste v tomto procesu nevytvořili bezpečnostní otvor.</span><span class="sxs-lookup"><span data-stu-id="875a6-111">You must be careful that you do not create a security hole in this process.</span></span> <span data-ttu-id="875a6-112">Obvykle to znamená, že musíte vyžadovat vhodné oprávnění volajících a potom použít nespravovaný kód k provedení pouze toho, co toto oprávnění povoluje a ještě více.</span><span class="sxs-lookup"><span data-stu-id="875a6-112">Usually, this means that you must demand a suitable permission of your callers and then use unmanaged code to perform only what that permission allows and no more.</span></span> <span data-ttu-id="875a6-113">V některých případech (například funkce získat denní čas) může být nespravovaný kód přímo vystaven volajícím bez jakýchkoli kontrol zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="875a6-113">In some cases (for example, a get time-of-day function), unmanaged code can be directly exposed to callers without any security checks.</span></span> <span data-ttu-id="875a6-114">V každém případě musí jakýkoliv kód, který výrazy vyhodnotit, být zodpovědný za zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="875a6-114">In any case, any code that asserts must take responsibility for security.</span></span>  
  
 <span data-ttu-id="875a6-115">Vzhledem k tomu, že jakýkoli spravovaný kód, který poskytuje cestu kódu do nativního kódu, je potenciální cíl pro škodlivý kód, určení, který nespravovaný kód lze bezpečně použít a jak musí být použit, vyžaduje extrémní péči.</span><span class="sxs-lookup"><span data-stu-id="875a6-115">Because any managed code that provides a code path into native code is a potential target for malicious code, determining which unmanaged code can be safely used and how it must be used requires extreme care.</span></span> <span data-ttu-id="875a6-116">Obecně by nespravovaný kód neměl být nikdy přímo vystaven částečně důvěryhodným volajícím.</span><span class="sxs-lookup"><span data-stu-id="875a6-116">Generally, unmanaged code should never be directly exposed to partially trusted callers.</span></span> <span data-ttu-id="875a6-117">Existují dva hlavní předpoklady při hodnocení bezpečnosti nespravovaného kódu v knihovnách, které jsou vyhodnoceny částečně důvěryhodným kódem:</span><span class="sxs-lookup"><span data-stu-id="875a6-117">There are two primary considerations in evaluating the safety of unmanaged code use in libraries that are callable by partially trusted code:</span></span>  
  
- <span data-ttu-id="875a6-118">**Funkce**.</span><span class="sxs-lookup"><span data-stu-id="875a6-118">**Functionality**.</span></span> <span data-ttu-id="875a6-119">Poskytuje nespravované rozhraní API funkce, které neumožňují volajícím provádět potenciálně nebezpečné operace?</span><span class="sxs-lookup"><span data-stu-id="875a6-119">Does the unmanaged API provide functionality that does not allow callers to perform potentially dangerous operations?</span></span> <span data-ttu-id="875a6-120">Zabezpečení přístupu kódu používá oprávnění k vymáhání přístupu k prostředkům, proto zvažte, zda rozhraní API používá soubory, uživatelské rozhraní nebo vlákna nebo zda zpřístupňuje chráněné informace.</span><span class="sxs-lookup"><span data-stu-id="875a6-120">Code access security uses permissions to enforce access to resources, so consider whether the API uses files, a user interface, or threading, or whether it exposes protected information.</span></span> <span data-ttu-id="875a6-121">V takovém případě před tím, než povolíte jeho zadání, musí zabalení spravovaného kódu vyžadovat potřebná oprávnění.</span><span class="sxs-lookup"><span data-stu-id="875a6-121">If it does, the managed code wrapping it must demand the necessary permissions before allowing it to be entered.</span></span> <span data-ttu-id="875a6-122">Kromě toho, přestože není chráněn oprávněním, musí být přístup k paměti omezen na přísnou bezpečnost typů.</span><span class="sxs-lookup"><span data-stu-id="875a6-122">Additionally, while not protected by a permission, memory access must be confined to strict type safety.</span></span>  
  
- <span data-ttu-id="875a6-123">**Kontrola parametru**.</span><span class="sxs-lookup"><span data-stu-id="875a6-123">**Parameter checking**.</span></span> <span data-ttu-id="875a6-124">Běžný útok předá neočekávaným parametrům zpřístupnění metod rozhraní API nespravovaného kódu v pokusu o jejich fungování ze specifikace.</span><span class="sxs-lookup"><span data-stu-id="875a6-124">A common attack passes unexpected parameters to exposed unmanaged code API methods in an attempt to cause them to operate out of specification.</span></span> <span data-ttu-id="875a6-125">Přetečení vyrovnávací paměti pomocí indexu mimo rozsah nebo hodnot posunutí představují jeden běžný příklad tohoto typu útoku, stejně jako všechny parametry, které mohou zneužít chybu v podkladovém kódu.</span><span class="sxs-lookup"><span data-stu-id="875a6-125">Buffer overruns using out-of-range index or offset values are one common example of this type of attack, as are any parameters that might exploit a bug in the underlying code.</span></span> <span data-ttu-id="875a6-126">Proto i v případě, že je rozhraní API nespravovaného kódu funkčně bezpečné (po nezbytných požadavcích) pro částečně důvěryhodné volající, musí spravovaný kód také zkontrolovat platnost parametru vyčerpáním, aby se zajistilo, že žádná nezamýšlená volání nejsou možná ze škodlivého kódu pomocí spravovaného vrstva obálky kódu.</span><span class="sxs-lookup"><span data-stu-id="875a6-126">Thus, even if the unmanaged code API is functionally safe (after necessary demands) for partially trusted callers, managed code must also check parameter validity exhaustively to ensure that no unintended calls are possible from malicious code using the managed code wrapper layer.</span></span>  
  
## <a name="using-suppressunmanagedcodesecurityattribute"></a><span data-ttu-id="875a6-127">Používání atributu SuppressUnmanagedCodeSecurityAttribute</span><span class="sxs-lookup"><span data-stu-id="875a6-127">Using SuppressUnmanagedCodeSecurityAttribute</span></span>  
 <span data-ttu-id="875a6-128">Existuje aspekt výkonu pro uplatnění a následné volání nespravovaného kódu.</span><span class="sxs-lookup"><span data-stu-id="875a6-128">There is a performance aspect to asserting and then calling unmanaged code.</span></span> <span data-ttu-id="875a6-129">Pro každé takové volání systém zabezpečení automaticky požaduje oprávnění nespravovaného kódu, což vede k pokaždému procházení zásobníku.</span><span class="sxs-lookup"><span data-stu-id="875a6-129">For every such call, the security system automatically demands unmanaged code permission, resulting in a stack walk each time.</span></span> <span data-ttu-id="875a6-130">Pokud provedete vyhodnocení a ihned volání nespravovaného kódu, procházení zásobníku může být nevýznamné: skládá se z vašeho kontrolního výrazu a volání nespravovaného kódu.</span><span class="sxs-lookup"><span data-stu-id="875a6-130">If you assert and immediately call unmanaged code, the stack walk can be meaningless: it consists of your assert and your unmanaged code call.</span></span>  
  
 <span data-ttu-id="875a6-131">Vlastní atribut s názvem <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> lze použít na vstupní body nespravovaného kódu, aby bylo možné zakázat normální kontrolu <xref:System.Security.Permissions.SecurityPermission> zabezpečení, <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> která vyžaduje zadané oprávnění.</span><span class="sxs-lookup"><span data-stu-id="875a6-131">A custom attribute called <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> can be applied to unmanaged code entry points to disable the normal security check that demands <xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> permission specified.</span></span> <span data-ttu-id="875a6-132">Při tomto postupu je třeba vzít v úvahu extrémní opatrnost, protože tato akce vytvoří otevřené dveře do nespravovaného kódu bez kontrol zabezpečení za běhu.</span><span class="sxs-lookup"><span data-stu-id="875a6-132">Extreme caution must always be taken when doing this, because this action creates an open door into unmanaged code with no runtime security checks.</span></span> <span data-ttu-id="875a6-133">Je třeba poznamenat, že i když bylo použito **SuppressUnmanagedCodeSecurityAttribute** , existuje jednorázová kontrola zabezpečení, ke které dojde při kompilaci JIT (just-in-time) k zajištění, že okamžitý volající má oprávnění k volání nespravovaného kódu.</span><span class="sxs-lookup"><span data-stu-id="875a6-133">It should be noted that even with **SuppressUnmanagedCodeSecurityAttribute** applied, there is a one-time security check that happens at just-in-time (JIT) compilation to ensure that the immediate caller has permission to call unmanaged code.</span></span>  
  
 <span data-ttu-id="875a6-134">Pokud použijete **SuppressUnmanagedCodeSecurityAttribute**, podívejte se na následující body:</span><span class="sxs-lookup"><span data-stu-id="875a6-134">If you use the **SuppressUnmanagedCodeSecurityAttribute**, check the following points:</span></span>  
  
- <span data-ttu-id="875a6-135">Zpřístupněte vstupní bod nespravovaného kódu jako interní nebo jinak nepřístupný mimo váš kód.</span><span class="sxs-lookup"><span data-stu-id="875a6-135">Make the unmanaged code entry point internal or otherwise inaccessible outside your code.</span></span>  
  
- <span data-ttu-id="875a6-136">Jakékoli volání do nespravovaného kódu je potenciální bezpečnostní otvor.</span><span class="sxs-lookup"><span data-stu-id="875a6-136">Any call into unmanaged code is a potential security hole.</span></span> <span data-ttu-id="875a6-137">Ujistěte se, že váš kód není portálem pro škodlivý kód pro nepřímo se zavoláním do nespravovaného kódu a vyhnete se kontrole zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="875a6-137">Make sure your code is not a portal for malicious code to indirectly call into unmanaged code and avoid a security check.</span></span> <span data-ttu-id="875a6-138">V případě potřeby oprávnění na vyžádání.</span><span class="sxs-lookup"><span data-stu-id="875a6-138">Demand permissions, if appropriate.</span></span>  
  
- <span data-ttu-id="875a6-139">Použijte konvenci pojmenování k explicitní identifikaci při vytváření nebezpečné cesty k nespravovanému kódu, jak je popsáno v následující části.</span><span class="sxs-lookup"><span data-stu-id="875a6-139">Use a naming convention to explicitly identify when you are creating a dangerous path into unmanaged code, as described in the section below..</span></span>  
  
## <a name="naming-convention-for-unmanaged-code-methods"></a><span data-ttu-id="875a6-140">Konvence pojmenování pro metody nespravovaného kódu</span><span class="sxs-lookup"><span data-stu-id="875a6-140">Naming convention for unmanaged code methods</span></span>  
 <span data-ttu-id="875a6-141">Pro pojmenovávání metod nespravovaného kódu se vytvořila užitečná a vysoce doporučená konvence.</span><span class="sxs-lookup"><span data-stu-id="875a6-141">A useful and highly recommended convention has been established for naming unmanaged code methods.</span></span> <span data-ttu-id="875a6-142">Všechny metody nespravovaného kódu jsou rozdělené do tří kategorií: **bezpečné**, **nativní**a **nebezpečné**.</span><span class="sxs-lookup"><span data-stu-id="875a6-142">All unmanaged code methods are separated into three categories: **safe**, **native**, and **unsafe**.</span></span> <span data-ttu-id="875a6-143">Tato klíčová slova lze použít jako názvy tříd, v rámci kterých jsou definovány různé druhy vstupních bodů nespravovaného kódu.</span><span class="sxs-lookup"><span data-stu-id="875a6-143">These keywords can be used as class names within which the various kinds of unmanaged code entry points are defined.</span></span> <span data-ttu-id="875a6-144">Ve zdrojovém kódu by tato klíčová slova měla být přidána do názvu třídy, `Safe.GetTimeOfDay`jako `Native.Xyz`v, `Unsafe.DangerousAPI`nebo například.</span><span class="sxs-lookup"><span data-stu-id="875a6-144">In source code, these keywords should be added to the class name, as in `Safe.GetTimeOfDay`, `Native.Xyz`, or `Unsafe.DangerousAPI`, for example.</span></span> <span data-ttu-id="875a6-145">Každé z těchto klíčových slov poskytuje užitečné informace o zabezpečení pro vývojáře využívající tuto třídu, jak je popsáno v následující tabulce.</span><span class="sxs-lookup"><span data-stu-id="875a6-145">Each of these keywords provides useful security information for developers using that class, as described in the following table.</span></span>  
  
|<span data-ttu-id="875a6-146">Klíčové slovo</span><span class="sxs-lookup"><span data-stu-id="875a6-146">Keyword</span></span>|<span data-ttu-id="875a6-147">Důležité informace o zabezpečení</span><span class="sxs-lookup"><span data-stu-id="875a6-147">Security considerations</span></span>|  
|-------------|-----------------------------|  
|<span data-ttu-id="875a6-148">**odvod**</span><span class="sxs-lookup"><span data-stu-id="875a6-148">**safe**</span></span>|<span data-ttu-id="875a6-149">Zcela neškodný pro jakýkoliv kód, dokonce i škodlivý kód, který se má volat.</span><span class="sxs-lookup"><span data-stu-id="875a6-149">Completely harmless for any code, even malicious code, to call.</span></span> <span data-ttu-id="875a6-150">Dá se použít stejně jako jiný spravovaný kód.</span><span class="sxs-lookup"><span data-stu-id="875a6-150">Can be used just like other managed code.</span></span> <span data-ttu-id="875a6-151">Například funkce, která získá denní čas, je obvykle bezpečná.</span><span class="sxs-lookup"><span data-stu-id="875a6-151">For example, a function that gets the time of day is typically safe.</span></span>|  
|<span data-ttu-id="875a6-152">**nativní**</span><span class="sxs-lookup"><span data-stu-id="875a6-152">**native**</span></span>|<span data-ttu-id="875a6-153">Zabezpečení neutrální; To znamená, že nespravovaný kód, který vyžaduje oprávnění nespravovaného kódu pro volání.</span><span class="sxs-lookup"><span data-stu-id="875a6-153">Security-neutral; that is, unmanaged code that requires unmanaged code permission to call.</span></span> <span data-ttu-id="875a6-154">Kontroluje se zabezpečení, které zastaví neoprávněného volajícího.</span><span class="sxs-lookup"><span data-stu-id="875a6-154">Security is checked, which stops an unauthorized caller.</span></span>|  
|<span data-ttu-id="875a6-155">**unsafe**</span><span class="sxs-lookup"><span data-stu-id="875a6-155">**unsafe**</span></span>|<span data-ttu-id="875a6-156">Potenciálně nebezpečný vstupní bod nespravovaného kódu s potlačeným zabezpečením.</span><span class="sxs-lookup"><span data-stu-id="875a6-156">Potentially dangerous unmanaged code entry point with security suppressed.</span></span> <span data-ttu-id="875a6-157">Vývojáři by měli při použití takového nespravovaného kódu využít největší opatrnost, aby se zajistila ochrana před ohrožením zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="875a6-157">Developers should use the greatest caution when using such unmanaged code, making sure that other protections are in place to prevent a security vulnerability.</span></span> <span data-ttu-id="875a6-158">Vývojáři musí být odpovědni, protože toto klíčové slovo Přepisuje systém zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="875a6-158">Developers must be responsible, as this keyword overrides the security system.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="875a6-159">Viz také:</span><span class="sxs-lookup"><span data-stu-id="875a6-159">See also</span></span>

- [<span data-ttu-id="875a6-160">Pokyny pro zabezpečené kódování</span><span class="sxs-lookup"><span data-stu-id="875a6-160">Secure Coding Guidelines</span></span>](../../standard/security/secure-coding-guidelines.md)
